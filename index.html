<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Govi Measure App</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --p-color: #10b981;
            --p-color-dark: #059669;
            --p-color-light: #34d399;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-dark: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --txt: #ffffff;
            --txt-secondary: #e2e8f0;
            --card: rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg: var(--bg-dark);
            --txt: #f1f5f9;
            --card: rgba(30, 41, 59, 0.4);
            --glass: rgba(30, 41, 59, 0.3);
            --glass-border: rgba(148, 163, 184, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--txt);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            min-height: 100vh;
            backdrop-filter: blur(10px);
        }

        /* Tab Bar - Glassmorphism */
        .tab-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            display: flex;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            padding: 8px;
            z-index: 1000;
            height: 70px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--txt-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            border-radius: 16px;
            padding: 10px 5px;
            position: relative;
            overflow: hidden;
        }

        .tab i {
            font-size: 20px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: white;
            background: linear-gradient(135deg, var(--p-color), var(--p-color-dark));
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .tab.active i {
            transform: translateY(-2px);
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .tab:active::before {
            width: 100px;
            height: 100px;
        }

        /* Pages */
        .page {
            display: none;
            height: calc(100vh - 90px);
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page.active {
            display: block;
        }

        /* Map Page */
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            border-radius: 0;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            pointer-events: none;
        }

        .search-container {
            pointer-events: auto;
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 5px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-container input {
            flex: 1;
            border: none;
            padding: 12px 20px;
            outline: none;
            border-radius: 50px;
            font-size: 14px;
            background: transparent;
        }

        .search-container button {
            border: none;
            background: linear-gradient(135deg, var(--p-color), var(--p-color-dark));
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .search-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .search-container button:active {
            transform: translateY(0);
        }

        .map-controls {
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: slideIn 0.5s ease-out 0.2s both;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .m-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            color: var(--p-color-dark);
            cursor: pointer;
            pointer-events: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 22px;
            position: relative;
            overflow: hidden;
        }

        .m-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(16, 185, 129, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .m-btn:active::before {
            width: 100px;
            height: 100px;
        }

        .m-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .m-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .m-btn.rec {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
        }

        .info-panel {
            position: absolute;
            bottom: 100px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #1e293b;
            padding: 16px;
            border-radius: 16px;
            font-size: 14px;
            pointer-events: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow);
            animation: slideInLeft 0.5s ease-out 0.1s both;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .info-panel #acres-disp {
            font-size: 24px;
            font-weight: bold;
            color: var(--p-color-dark);
            display: block;
            margin-bottom: 4px;
        }

        .info-panel #sinhala-disp {
            color: #64748b;
            font-size: 13px;
        }

        /* Cards - Glassmorphism */
        .card {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            animation: cardAppear 0.6s ease-out;
        }

        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease-out;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--txt-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--txt);
            font-size: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        input:focus {
            outline: none;
            border-color: var(--p-color-light);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border), transparent);
            margin: 25px 0;
        }

        /* Bill Page Specific */
        #final-total {
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        #final-acres {
            color: var(--p-color-light);
            font-weight: 500;
        }

        .btn {
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            display: block;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 200px;
            height: 200px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Settings Page */
        #page-settings .card label {
            color: white;
            font-size: 16px;
            margin-bottom: 12px;
            display: block;
        }

        /* Print Bill */
        #bill-ready {
            display: none;
            background: white;
            color: #1e293b;
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: var(--shadow);
        }

        @media print {
            body * {
                display: none;
            }
            #bill-ready, #bill-ready * {
                display: block !important;
            }
            #bill-ready {
                box-shadow: none;
                margin: 0;
                padding: 20px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--p-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--p-color-dark);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--p-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .tab-bar {
                width: 95%;
                height: 65px;
                bottom: 10px;
            }
            
            .m-btn {
                width: 55px;
                height: 55px;
            }
            
            .page {
                padding: 15px;
            }
        }
    </style>
</head>
<body>

    <!-- Your HTML content remains exactly the same -->
    <div id="page-map" class="page active" style="padding:0;">
        <div class="map-overlay">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="නගරය සොයන්න (Search City)...">
                <button onclick="searchPlace()"><i class="fa fa-search"></i></button>
            </div>
        </div>
        
        <div id="map"></div>

        <div class="info-panel">
            <span id="acres-disp">0.00</span> අක්කර<br>
            <small id="sinhala-disp">ලකුණු කරන්න</small>
        </div>
        
        <div class="map-controls">
            <button class="m-btn" onclick="locateMe()"><i class="fa fa-crosshairs"></i></button>
            <button id="track-btn" class="m-btn" onclick="toggleTracking()" title="GPS Tracking"><i class="fa fa-walking"></i></button>
            <button class="m-btn" onclick="clearMap()"><i class="fa fa-trash-alt"></i></button>
        </div>
    </div>

    <div id="page-bill" class="page">
        <h2 id="lang-bill-head">බිල්පත් විස්තර</h2>
        <div class="card">
            <div class="input-group">
                <label>වැඩේ නම (Service Name):</label>
                <input type="text" id="job-name" placeholder="උදා: අස්වනු නෙලීම">
            </div>
            <div class="input-group">
                <label>පාරිභෝගිකයාගේ නම:</label>
                <input type="text" id="cust-name">
            </div>
            <div class="input-group">
                <label>අක්කරයක මිල (රු):</label>
                <input type="number" id="unit-price" value="25000" oninput="calcTotal()">
            </div>
            <hr>
            <div style="text-align: center;">
                <h3 style="color:var(--p-color-light); margin-bottom:5px;">මුළු මුදල: රු. <span id="final-total">0.00</span></h3>
                <small>(අක්කර <span id="final-acres">0.00</span> ක් සඳහා)</small>
            </div>
            <button class="btn" style="width:100%; border-radius:12px; background:linear-gradient(135deg, var(--p-color), var(--p-color-dark)); color:white; margin-top:20px; padding:18px;" onclick="generateBill()">බිල්පත (Print)</button>
        </div>
    </div>

    <div id="page-settings" class="page">
        <h2>සෙටින්ස්</h2>
        <div class="card">
            <label>පෙනුම (Mode):</label>
            <button class="btn" style="width:100%; border-radius:12px; margin-top:5px; background:var(--card); border:1px solid var(--glass-border);" onclick="toggleTheme()"><i class="fa fa-moon"></i> Dark / Light</button>
            <br><br>
            <label>පින්ටර් සම්බන්ධතාවය:</label>
            <button class="btn" style="width:100%; border-radius:12px; background:linear-gradient(135deg, #6366f1, #8b5cf6); color:white;" onclick="alert('සොයමින්...')"><i class="fa fa-bluetooth"></i> Connect Bluetooth Printer</button>
        </div>
    </div>

    <div id="bill-ready">
        <center>
            <h1 id="pb-title" style="color:#10b981;">සේවා බිල්පත</h1>
            <p>Customer: <span id="pb-cust"></span></p>
            <hr>
        </center>
        <p>දිනය: <span id="pb-date"></span></p>
        <p>ප්‍රමාණය: <span id="pb-size"></span></p>
        <p>අක්කරයක මිල: රු. <span id="pb-rate"></span></p>
        <hr>
        <h2 style="text-align:right">එකතුව: රු. <span id="pb-total"></span></h2>
        <center><p style="margin-top:30px; font-size:12px; color:#64748b;">Generated by Govi Measure App</p></center>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="showPage('map', this)"><i class="fa fa-map"></i>මැප් එක</div>
        <div class="tab" onclick="showPage('bill', this)"><i class="fa fa-file-invoice"></i>බිල්පත</div>
        <div class="tab" onclick="showPage('settings', this)"><i class="fa fa-sliders-h"></i>සෙටින්ස්</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>

    <!-- Your JavaScript remains exactly the same -->
    <script>
        // Init Map with extra zoom
        var map = L.map('map', { zoomControl: false, maxZoom: 21 }).setView([7.8731, 80.7718], 15);
        
        var satellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 21, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Manual Marking (Dots)
        var drawControl = new L.Control.Draw({
            draw: {
                polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#10b981' } },
                polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
            },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            var layer = e.layer;
            drawnItems.addLayer(layer);
            updateCalculations(layer);
            
            layer.on('edit', function() { updateCalculations(layer); });
        });

        // Search Function (Working Fix)
        async function searchPlace() {
            let query = document.getElementById('search-input').value;
            if(!query) return;
            try {
                let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}, Sri Lanka`);
                let data = await res.json();
                if(data.length > 0) {
                    map.setView([data[0].lat, data[0].lon], 17);
                } else {
                    alert("ස්ථානය හමු වුණේ නැත.");
                }
            } catch(e) { alert("සර්ච් එකේ ගැටලුවක්."); }
        }

        // GPS & Tracking
        let isTracking = false, watchId, trackPoints = [], trackPoly = L.polygon([], {color: '#f00'}).addTo(map);

        function toggleTracking() {
            if(!isTracking) {
                isTracking = true;
                trackPoints = [];
                drawnItems.clearLayers();
                document.getElementById('track-btn').classList.add('rec');
                watchId = navigator.geolocation.watchPosition(p => {
                    let loc = [p.coords.latitude, p.coords.longitude];
                    trackPoints.push(loc);
                    trackPoly.setLatLngs(trackPoints);
                    map.panTo(loc);
                    updateCalculations(trackPoly);
                }, null, { enableHighAccuracy: true });
            } else {
                isTracking = false;
                navigator.geolocation.clearWatch(watchId);
                document.getElementById('track-btn').classList.remove('rec');
            }
        }

        function updateCalculations(layer) {
            let latlngs = layer.getLatLngs();
            if(latlngs.length === 0) return;
            let areaSqM = L.GeometryUtil.geodesicArea(latlngs[0]);
            let acres = areaSqM / 4046.86;
            
            currentAcres = acres;
            document.getElementById('acres-disp').innerText = acres.toFixed(2);
            document.getElementById('final-acres').innerText = acres.toFixed(2);
            
            // Sinhala Terms
            let dec = acres % 1;
            let text = Math.floor(acres) > 0 ? Math.floor(acres) + " අක්කර " : "";
            if(dec > 0.15 && dec < 0.40) text += "කාලයි";
            else if(dec >= 0.40 && dec < 0.65) text += "බාගයයි";
            else if(dec >= 0.65 && dec < 0.90) text += "තුන්කාලයි";
            document.getElementById('sinhala-disp').innerText = text || "මනින ලදී";
            calcTotal();
        }

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            el.classList.add('active');
            if(id === 'map') setTimeout(() => map.invalidateSize(), 200);
        }

        function locateMe() { map.locate({setView: true, maxZoom: 18}); }
        function clearMap() { drawnItems.clearLayers(); trackPoly.setLatLngs([]); currentAcres = 0; }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        function calcTotal() {
            let rate = document.getElementById('unit-price').value || 0;
            document.getElementById('final-total').innerText = (currentAcres * rate).toLocaleString();
        }

        function generateBill() {
            document.getElementById('pb-title').innerText = document.getElementById('job-name').value || "සේවා බිල්පත";
            document.getElementById('pb-cust').innerText = document.getElementById('cust-name').value;
            document.getElementById('pb-date').innerText = new Date().toLocaleDateString();
            document.getElementById('pb-size').innerText = currentAcres.toFixed(2) + " Acres";
            document.getElementById('pb-rate').innerText = document.getElementById('unit-price').value;
            document.getElementById('pb-total').innerText = document.getElementById('final-total').innerText;
            window.print();
        }
    </script>
</body>
</html>
